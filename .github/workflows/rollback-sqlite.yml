name: ðŸ”„ SQLite Rollback & Recovery

on:
  workflow_dispatch:
    inputs:
      rollback_type:
        description: 'ðŸ”„ Type of rollback to perform'
        required: true
        type: choice
        options:
        - database_only
        - application_only
        - full_rollback
      backup_file:
        description: 'ðŸ’¾ Backup file to restore from (format: management_YYYYMMDD_HHMMSS.db.gz)'
        required: false
        type: string
      git_commit:
        description: 'ðŸ“ Git commit to rollback to (leave empty for previous commit)'
        required: false
        type: string
      confirm_rollback:
        description: 'âš ï¸ Type "rollback" to confirm this action'
        required: true
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_rollback == 'rollback'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: ðŸ“‹ Rollback Information
      run: |
        echo "ðŸ”„ SQLite Rollback & Recovery"
        echo "============================="
        echo "ðŸ”„ Rollback type: ${{ github.event.inputs.rollback_type }}"
        echo "ðŸ’¾ Backup file: ${{ github.event.inputs.backup_file || 'Latest available' }}"
        echo "ðŸ“ Git commit: ${{ github.event.inputs.git_commit || 'Previous commit' }}"
        echo "ðŸ‘¤ Initiated by: ${{ github.actor }}"
        echo "ðŸ“… Time: $(date)"
        echo ""
        echo "âš ï¸ This is a ROLLBACK operation - proceed with caution!"
    
    - name: ðŸ”„ Execute Rollback
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ðŸ”„ Starting SQLite rollback procedure..."
          cd /home/ubuntu/ManagementApp
          
          # Pre-rollback backup
          echo "ðŸ’¾ Creating pre-rollback backup..."
          cd aws-deployment
          bash enhanced-backup.sh
          
          # Determine rollback strategy
          ROLLBACK_TYPE="${{ github.event.inputs.rollback_type }}"
          
          if [ "$ROLLBACK_TYPE" = "database_only" ]; then
            echo "ðŸ—„ï¸ Database-only rollback..."
            
            # Stop application
            echo "â¸ï¸ Stopping application..."
            docker-compose -f docker-compose.prod.yml stop server-app
            
            # Restore database
            if [ -n "${{ github.event.inputs.backup_file }}" ]; then
              echo "ðŸ“¥ Restoring from specified backup: ${{ github.event.inputs.backup_file }}"
              bash restore-sqlite.sh ${{ github.event.inputs.backup_file }}
            else
              echo "ðŸ“¥ Restoring from latest backup..."
              LATEST_BACKUP=$(ls -t /home/ubuntu/ManagementApp/data/backups/management_*.db.gz | head -1)
              if [ -n "$LATEST_BACKUP" ]; then
                BACKUP_NAME=$(basename "$LATEST_BACKUP")
                bash restore-sqlite.sh "$BACKUP_NAME"
              else
                echo "âŒ No backups found!"
                exit 1
              fi
            fi
            
            # Start application
            echo "â–¶ï¸ Starting application..."
            docker-compose -f docker-compose.prod.yml start server-app
            
          elif [ "$ROLLBACK_TYPE" = "application_only" ]; then
            echo "ðŸ“± Application-only rollback..."
            
            # Git rollback
            if [ -n "${{ github.event.inputs.git_commit }}" ]; then
              echo "ðŸ“ Rolling back to commit: ${{ github.event.inputs.git_commit }}"
              git checkout ${{ github.event.inputs.git_commit }}
            else
              echo "ðŸ“ Rolling back to previous commit..."
              git checkout HEAD~1
            fi
            
            # Redeploy application
            echo "ðŸš€ Redeploying application..."
            bash deploy.sh
            
          elif [ "$ROLLBACK_TYPE" = "full_rollback" ]; then
            echo "ðŸ”„ Full system rollback..."
            
            # Stop all services
            echo "â¸ï¸ Stopping all services..."
            docker-compose -f docker-compose.prod.yml down
            
            # Git rollback
            if [ -n "${{ github.event.inputs.git_commit }}" ]; then
              echo "ðŸ“ Rolling back to commit: ${{ github.event.inputs.git_commit }}"
              git checkout ${{ github.event.inputs.git_commit }}
            else
              echo "ðŸ“ Rolling back to previous commit..."
              git checkout HEAD~1
            fi
            
            # Database rollback
            if [ -n "${{ github.event.inputs.backup_file }}" ]; then
              echo "ðŸ“ Restoring database from: ${{ github.event.inputs.backup_file }}"
              bash restore-sqlite.sh ${{ github.event.inputs.backup_file }}
            else
              echo "ðŸ“ Restoring database from latest backup..."
              LATEST_BACKUP=$(ls -t /home/ubuntu/ManagementApp/data/backups/management_*.db.gz | head -1)
              if [ -n "$LATEST_BACKUP" ]; then
                BACKUP_NAME=$(basename "$LATEST_BACKUP")
                bash restore-sqlite.sh "$BACKUP_NAME"
              else
                echo "âš ï¸ No database backups found, keeping current database"
              fi
            fi
            
            # Full redeploy
            echo "ðŸš€ Full system redeploy..."
            bash setup-sqlite.sh
            bash deploy.sh
            
          fi
          
          echo "â³ Waiting for services to stabilize..."
          sleep 45
          
          echo "ðŸ¥ Running post-rollback health checks..."
          if bash health-check-sqlite.sh; then
            echo "âœ… Rollback successful - all health checks passed!"
          else
            echo "âŒ Rollback health check failed!"
            echo "ðŸ“‹ Checking logs..."
            docker-compose -f docker-compose.prod.yml logs --tail=30
            exit 1
          fi
          
          echo "ðŸ“Š Running performance verification..."
          bash monitor-sqlite.sh
          
          echo "ðŸŽ‰ SQLite rollback completed successfully!"
          echo "ðŸŒ Application: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)"
          echo "ðŸ—„ï¸ Database: SQLite optimized"
          echo "ðŸ“Š Status: All systems operational"

    - name: ðŸ“Š Post-Rollback Verification
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ðŸ“Š Running extended post-rollback verification..."
          cd /home/ubuntu/ManagementApp/aws-deployment
          
          # Wait a bit more
          sleep 30
          
          # Extended health check
          bash health-check-sqlite.sh
          
          # Performance monitoring
          bash log-performance.sh
          
          # Generate rollback report
          cat > /home/ubuntu/ManagementApp/data/logs/rollback-report-$(date +%Y%m%d_%H%M%S).log << EOF
SQLite Rollback Report
======================
Date: $(date)
Type: ${{ github.event.inputs.rollback_type }}
Initiated by: ${{ github.actor }}
Backup used: ${{ github.event.inputs.backup_file || 'Latest available' }}
Git commit: ${{ github.event.inputs.git_commit || 'Previous commit' }}

System Status:
$(bash health-check-sqlite.sh)

Performance:
$(bash monitor-sqlite.sh)

Container Status:
$(docker-compose -f docker-compose.prod.yml ps)
EOF
          
          echo "ðŸ“‹ Rollback report generated!"

    - name: âœ… Rollback Success Summary
      if: success()
      run: |
        echo "ðŸŽ‰ SQLite Rollback Completed Successfully!"
        echo "==========================================="
        echo "âœ… Rollback type: ${{ github.event.inputs.rollback_type }}"
        echo "âœ… Database: ${{ github.event.inputs.backup_file && 'Restored from backup' || 'Kept current or restored from latest' }}"
        echo "âœ… Application: ${{ github.event.inputs.git_commit && 'Rolled back to specified commit' || 'Rolled back to previous commit' }}"
        echo "âœ… Health checks: All passed"
        echo "âœ… Performance: Verified"
        echo "âœ… Status: System operational"
        echo ""
        echo "ðŸ“‹ Rollback report generated on server"
        echo "ðŸ‘€ Monitor the application for any issues"
        
    - name: âŒ Rollback Failed
      if: failure()
      run: |
        echo "âŒ SQLite Rollback Failed!"
        echo "========================="
        echo "ðŸ” Check EC2 logs for details"
        echo "ðŸ’¾ Pre-rollback backup was created"
        echo "ðŸ†˜ Contact administrator for manual recovery"
        echo ""
        echo "ðŸ› ï¸ Emergency recovery commands:"
        echo "  ssh into EC2 and run:"
        echo "  cd ManagementApp/aws-deployment"
        echo "  bash health-check-sqlite.sh"
        echo "  bash monitor-sqlite.sh"
        echo "  docker-compose -f docker-compose.prod.yml logs"
        echo "  # If needed, restore from pre-rollback backup"

  notify-rollback:
    needs: rollback
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“§ Rollback Notification
      run: |
        if [ "${{ needs.rollback.result }}" = "success" ]; then
          echo "ðŸŽ‰ SQLite Rollback Notification: SUCCESS"
          echo "======================================="
          echo "Type: ${{ github.event.inputs.rollback_type }}"
          echo "Initiated by: ${{ github.actor }}"
          echo "Status: Completed successfully"
          echo "Time: $(date)"
        else
          echo "âŒ SQLite Rollback Notification: FAILED"
          echo "======================================"
          echo "Type: ${{ github.event.inputs.rollback_type }}"
          echo "Initiated by: ${{ github.actor }}"
          echo "Status: Failed - requires manual intervention"
          echo "Time: $(date)"
        fi
