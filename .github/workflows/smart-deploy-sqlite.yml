name: ğŸ§  Smart SQLite Deploy

on:
  push:
    branches: [ main ]
    # Only trigger if specific files changed
    paths:
      - 'server-app/**'
      - 'client-app/**'
      - 'aws-deployment/**'
      - 'docker-compose.yml'
      - 'nginx.conf'

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      server-changed: ${{ steps.changes.outputs.server }}
      client-changed: ${{ steps.changes.outputs.client }}
      deployment-changed: ${{ steps.changes.outputs.deployment }}
      
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 2
        
    - uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          server:
            - 'server-app/**'
          client:
            - 'client-app/**'
          deployment:
            - 'aws-deployment/**'
            - 'docker-compose.yml'
            - 'nginx.conf'

  deploy:
    needs: check-changes
    runs-on: ubuntu-latest
    if: |
      needs.check-changes.outputs.server == 'true' || 
      needs.check-changes.outputs.client == 'true' || 
      needs.check-changes.outputs.deployment == 'true'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: ğŸ“‹ Smart Deployment Analysis
      run: |
        echo "ğŸ§  Smart SQLite Deployment Starting"
        echo "===================================="
        echo "ğŸ”„ Server changed: ${{ needs.check-changes.outputs.server }}"
        echo "âš›ï¸ Client changed: ${{ needs.check-changes.outputs.client }}"
        echo "ğŸš€ Deployment changed: ${{ needs.check-changes.outputs.deployment }}"
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
    
    - name: ğŸš€ Smart Deploy to SQLite Production
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸ“‹ Starting smart SQLite deployment..."
          cd /home/ubuntu/ManagementApp
          
          echo "ğŸ”„ Pulling latest changes..."
          git pull origin main
          
          cd aws-deployment
          
          echo "ğŸ’¾ Creating smart backup..."
          bash enhanced-backup.sh
          
          # Determine deployment strategy based on changes
          if [ "${{ needs.check-changes.outputs.deployment }}" == "true" ]; then
            echo "ğŸš€ Deployment config changed - full redeploy"
            bash setup-sqlite.sh
            bash deploy.sh
            
          elif [ "${{ needs.check-changes.outputs.server }}" == "true" ] && [ "${{ needs.check-changes.outputs.client }}" == "true" ]; then
            echo "ğŸ”„ Both server and client changed - rebuild both"
            docker-compose -f docker-compose.prod.yml up -d --build server-app client-app
            
          elif [ "${{ needs.check-changes.outputs.server }}" == "true" ]; then
            echo "ğŸ—ï¸ Server changes only - rebuild server"
            docker-compose -f docker-compose.prod.yml up -d --build server-app
            
          elif [ "${{ needs.check-changes.outputs.client }}" == "true" ]; then
            echo "âš›ï¸ Client changes only - rebuild client"
            docker-compose -f docker-compose.prod.yml up -d --build client-app
            
          fi
          
          # Always restart nginx to ensure routing works
          echo "ğŸŒ Restarting nginx..."
          docker-compose -f docker-compose.prod.yml restart nginx
          
          echo "â³ Waiting for services..."
          sleep 30
          
          echo "ğŸ¥ Running health verification..."
          if bash health-check-sqlite.sh; then
            echo "âœ… Smart deployment successful!"
          else
            echo "âŒ Health check failed!"
            echo "ğŸ“‹ Checking logs..."
            docker-compose -f docker-compose.prod.yml logs --tail=20
            exit 1
          fi
          
          echo "ğŸ“Š Performance check..."
          bash monitor-sqlite.sh
          
          echo "ğŸ§¹ Cleanup..."
          docker system prune -f
          
          echo "ğŸ‰ Smart SQLite deployment completed!"
          echo "ğŸŒ App: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)"

    - name: ğŸ“Š Smart Deployment Summary
      if: success()
      run: |
        echo "ğŸ§  Smart SQLite Deployment Successful!"
        echo "======================================"
        echo "ğŸ”„ Server rebuilt: ${{ needs.check-changes.outputs.server }}"
        echo "âš›ï¸ Client rebuilt: ${{ needs.check-changes.outputs.client }}"
        echo "ğŸš€ Config updated: ${{ needs.check-changes.outputs.deployment }}"
        echo "âœ… Health checks: Passed"
        echo "ğŸ’¾ Backup: Created"
        echo "ğŸ—„ï¸ Database: SQLite optimized"
        echo ""
        echo "âš¡ Deployment was optimized based on actual changes!"
        
    - name: âŒ Smart Deployment Failed
      if: failure()
      run: |
        echo "âŒ Smart SQLite Deployment Failed!"
        echo "=================================="
        echo "ğŸ” Check EC2 logs for details"
        echo "ğŸ’¾ Backup available for rollback"
        echo "ğŸ› ï¸ Run health-check-sqlite.sh for diagnosis"

  performance-monitoring:
    needs: deploy
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: ğŸ“ˆ Post-deployment Performance Monitoring
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸ“ˆ Running post-deployment monitoring..."
          cd /home/ubuntu/ManagementApp/aws-deployment
          
          # Wait a bit more for services to stabilize
          sleep 60
          
          # Performance monitoring
          bash log-performance.sh
          
          # Generate summary
          bash aggregate-logs.sh
          
          echo "ğŸ“Š Performance monitoring completed!"
