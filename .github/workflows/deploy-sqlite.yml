name: ğŸ—„ï¸ Enhanced SQLite Deploy

on:
  # Manual trigger only - Full control with SQLite integration!
  workflow_dispatch:
    inputs:
      environment:
        description: 'ğŸŒ Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      confirm_deploy:
        description: 'âš ï¸ Type "deploy" to confirm deployment'
        required: true
        type: string
      skip_build:
        description: 'âš¡ Skip Docker rebuild (faster, use existing images)'
        required: false
        default: false
        type: boolean
      create_backup:
        description: 'ğŸ’¾ Create backup before deployment'
        required: false
        default: true
        type: boolean
      run_maintenance:
        description: 'ğŸ”§ Run database maintenance after deployment'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_deploy == 'deploy'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: ğŸ“‹ Pre-deployment Info
      run: |
        echo "ğŸ—„ï¸ SQLite Production Deployment Starting"
        echo "========================================"
        echo "ğŸŒ Environment: ${{ github.event.inputs.environment }}"
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
        echo "ğŸŒ³ Branch: ${{ github.ref_name }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "âš¡ Skip rebuild: ${{ github.event.inputs.skip_build }}"
        echo "ğŸ’¾ Create backup: ${{ github.event.inputs.create_backup }}"
        echo "ğŸ”§ Run maintenance: ${{ github.event.inputs.run_maintenance }}"
    
    - name: ğŸš€ Deploy to SQLite Production EC2
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸ“‹ Starting enhanced SQLite deployment..."
          cd /home/ubuntu/ManagementApp
          
          echo "ğŸ”„ Pulling latest code from GitHub..."
          git pull origin main
          
          cd aws-deployment
          
          # Pre-deployment backup
          if [ "${{ github.event.inputs.create_backup }}" = "true" ]; then
            echo "ğŸ’¾ Creating pre-deployment backup..."
            if bash enhanced-backup.sh; then
              echo "âœ… Backup created successfully"
            else
              echo "âŒ Backup failed! Aborting deployment."
              exit 1
            fi
          else
            echo "â­ï¸ Skipping backup (as requested)"
          fi
          
          # SQLite setup
          echo "ğŸ—„ï¸ Ensuring SQLite production configuration..."
          bash setup-sqlite.sh
          
          # Deployment
          if [ "${{ github.event.inputs.skip_build }}" = "true" ]; then
            echo "âš¡ Fast deployment (skipping rebuild)..."
            docker-compose -f docker-compose.prod.yml down
            docker-compose -f docker-compose.prod.yml up -d
          else
            echo "ğŸ”¨ Full deployment with rebuild..."
            bash deploy.sh
          fi
          
          echo "â³ Waiting for services to start..."
          sleep 30
          
          # Health verification
          echo "ğŸ¥ Running comprehensive health checks..."
          if bash health-check-sqlite.sh; then
            echo "âœ… Health check passed!"
          else
            echo "âŒ Health check failed! Checking logs..."
            docker-compose -f docker-compose.prod.yml logs --tail=20
            exit 1
          fi
          
          # Performance check
          echo "ğŸ“Š Running performance verification..."
          bash monitor-sqlite.sh
          
          # Optional maintenance
          if [ "${{ github.event.inputs.run_maintenance }}" = "true" ]; then
            echo "ğŸ”§ Running database maintenance..."
            bash maintain-sqlite.sh
          fi
          
          # Final status
          echo "ğŸ‰ Enhanced SQLite deployment completed!"
          echo "ğŸŒ Application: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)"
          echo "ğŸ—„ï¸ Database: SQLite WAL mode"
          echo "ğŸ“Š Status: All systems operational"
          
    - name: ğŸ“Š Deployment Success Summary
      if: success()
      run: |
        echo "ğŸ‰ Enhanced SQLite Deployment Success!"
        echo "======================================"
        echo "âœ… Environment: ${{ github.event.inputs.environment }}"
        echo "âœ… Database: SQLite production optimized"
        echo "âœ… Backup: ${{ github.event.inputs.create_backup == 'true' && 'Created' || 'Skipped' }}"
        echo "âœ… Build: ${{ github.event.inputs.skip_build == 'true' && 'Skipped (fast)' || 'Full rebuild' }}"
        echo "âœ… Maintenance: ${{ github.event.inputs.run_maintenance == 'true' && 'Completed' || 'Skipped' }}"
        echo "âœ… Health: All checks passed"
        echo "âœ… Performance: Verified"
        echo ""
        echo "ğŸŒ Your SQLite application is ready!"
        
    - name: âŒ Deployment Failed  
      if: failure()
      run: |
        echo "âŒ Enhanced SQLite Deployment Failed!"
        echo "====================================="
        echo "ğŸŒ Environment: ${{ github.event.inputs.environment }}"
        echo "ğŸ“ Check EC2 logs for details"
        echo "ğŸ’¾ Pre-deployment backup available (if created)"
        echo "ğŸ”„ Consider rollback if needed"
        echo ""
        echo "ğŸ› ï¸ Troubleshooting commands:"
        echo "  ssh into EC2 and run:"
        echo "  cd ManagementApp/aws-deployment"
        echo "  bash health-check-sqlite.sh"
        echo "  bash monitor-sqlite.sh"
        echo "  docker-compose -f docker-compose.prod.yml logs"

  post-deployment:
    needs: deploy
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: ğŸ“§ Notify Success (Optional)
      run: |
        echo "ğŸ‰ SQLite deployment notification sent!"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Deployed by: ${{ github.actor }}"
        echo "Time: $(date)"
